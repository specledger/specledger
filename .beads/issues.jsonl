{"id":"sl-0e7","title":"Revise Comments CLI Command","description":"Add sl revise as a Cobra subcommand to fetch artifact comments from Supabase, present interactive TUI for processing, generate revision prompts, launch coding agent, and handle commit/push/resolve lifecycle.","design":"Go 1.24.2 + Cobra CLI + charmbracelet/huh forms + PostgREST client + text/template + os/exec. See specledger/136-revise-comments/plan.md for full architecture.","acceptance_criteria":"All 9 user stories (US1-US9) independently testable. SC-001: fetch \u003c5s, SC-002: full flow \u003c10min, SC-004: zero accidental resolution.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-02-20T11:47:44.13992+08:00","updated_at":"2026-02-20T11:47:44.13992+08:00","labels":["spec:136-revise-comments"]}
{"id":"sl-0r5","title":"Implement edge case handling across all flows","description":"Handle all edge cases from spec: file not found, selected_text not in file, deleted remote branch, stash failure, network errors.","design":"Across commands/revise.go and pkg/cli/revise/: 1) File not found: when displaying comment, check if file_path exists locally, flag with warning if missing. 2) selected_text not found: search file for selected_text, if not found show 'Original selected text not found in current file version' with surrounding context from line number if available. 3) Deleted remote branch: if checkout fails, catch error and re-show branch list. 4) Stash failure: if exec git stash fails, abort branch switch with clear message. 5) Network errors: wrap all client calls with context, show 'Check your network connection and try again.' 6) Editor not found: if exec fails for , fall back to terminal display + filename prompt.","acceptance_criteria":"Each edge case produces a clear, actionable error message. No panics or unhandled errors. Graceful degradation in all cases.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-20T13:15:29.515792+08:00","updated_at":"2026-02-20T13:15:29.515792+08:00","labels":["component:revise","phase:polish","requirement:FR-020","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-0r5","depends_on_id":"sl-ndj","type":"parent-child","created_at":"2026-02-20T13:15:29.516731+08:00","created_by":"daemon"}]}
{"id":"sl-2re","title":"Add lightweight pure-function tests","description":"Unit tests for template rendering, token estimation, fixture parsing — no HTTP mocking needed.","design":"Files: pkg/cli/revise/prompt_test.go, pkg/cli/revise/automation_test.go. Tests: 1) TestRenderPrompt — render template with sample RevisionContext, verify output contains expected sections. 2) TestEstimateTokens — verify len/3.5 heuristic for known inputs. 3) TestParseFixture — parse valid/invalid JSON fixtures. 4) TestMatchFixtureComments — verify matching by file_path+selected_text, verify warnings for unmatched. 5) Snapshot test: render prompt with fixture, compare to golden file. Use standard testing.T with table-driven tests (project convention). No testify needed.","acceptance_criteria":"All tests pass with go test ./pkg/cli/revise/.... Template renders correctly. Token estimation accurate. Fixture parsing handles valid/invalid input.","status":"open","priority":3,"issue_type":"task","created_at":"2026-02-20T13:15:29.646009+08:00","updated_at":"2026-02-20T13:15:29.646009+08:00","labels":["component:revise","phase:polish","spec:136-revise-comments","test:unit"],"dependencies":[{"issue_id":"sl-2re","depends_on_id":"sl-ndj","type":"parent-child","created_at":"2026-02-20T13:15:29.647246+08:00","created_by":"daemon"}]}
{"id":"sl-2xb","title":"Register sl revise command in main.go","description":"Create the Cobra command skeleton for sl revise and register it in the CLI root command.","design":"File: pkg/cli/commands/revise.go — define VarReviseCmd with Use:'revise [branch-name]', Short description, flags (--auto, --dry-run, --summary). Register in cmd/sl/main.go: rootCmd.AddCommand(commands.VarReviseCmd). RunE function starts as a placeholder calling fmt.Println('not implemented').","acceptance_criteria":"sl revise --help shows usage. sl revise prints 'not implemented'. Flags --auto, --dry-run, --summary registered.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:32:45.33848+08:00","updated_at":"2026-02-20T14:00:53.502313+08:00","closed_at":"2026-02-20T14:00:53.502313+08:00","labels":["component:cli","phase:setup","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-2xb","depends_on_id":"sl-ovq","type":"parent-child","created_at":"2026-02-20T12:32:45.339279+08:00","created_by":"daemon"}]}
{"id":"sl-4xh","title":"Foundational: Core infrastructure","description":"PostgREST client, git helpers, and agent launcher extension. These MUST complete before any user story.","design":"Three modules: client.go (PostgREST with 401 retry), git.go (branch/stash/commit), launcher.go (LaunchWithPrompt).","acceptance_criteria":"Client can fetch comments from Supabase. Git helpers detect branch, stash, checkout. LaunchWithPrompt spawns agent with TTY.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-20T12:33:05.019754+08:00","updated_at":"2026-02-20T14:07:38.782865+08:00","closed_at":"2026-02-20T14:07:38.782865+08:00","labels":["phase:foundational","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-4xh","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:33:05.020472+08:00","created_by":"daemon"},{"issue_id":"sl-4xh","depends_on_id":"sl-ovq","type":"blocks","created_at":"2026-02-20T12:45:16.306131+08:00","created_by":"daemon"}]}
{"id":"sl-5ao","title":"Implement PostgREST client with auth auto-retry","description":"Build the ReviseClient for all Supabase API interactions. This is the data access layer for the entire feature.","design":"File: pkg/cli/revise/client.go. Struct: ReviseClient{baseURL, anonKey, *http.Client}. Methods: GetProject(owner, name), GetSpec(projectID, specKey), GetChange(specID), FetchComments(changeID), ResolveComment(commentID), ListSpecsWithComments(projectID). Each method makes one PostgREST HTTP call. Add doWithRetry wrapper: on 401/PGRST303, call auth.GetValidAccessToken() and retry once. Follow session.MetadataClient pattern from pkg/cli/session/metadata.go. Use auth.GetSupabaseURL() and auth.GetSupabaseAnonKey() for config. See contracts/postgrest-api.md for all endpoints.","acceptance_criteria":"Client compiles. GetProject/GetSpec/GetChange/FetchComments chain works against live Supabase. ResolveComment marks comment resolved. doWithRetry refreshes token on 401.","notes":"IMPORTANT — ListSpecsWithComments aggregation: No single PostgREST endpoint exists. Requires multi-call client-side aggregation (see contracts/postgrest-api.md §6). Either: (a) fetch unresolved comments with joined spec data via PostgREST inner joins, or (b) fetch specs then count comments per spec client-side. Reference the contract section in code comments for future maintainers.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:34:14.46428+08:00","updated_at":"2026-02-20T14:07:04.999473+08:00","closed_at":"2026-02-20T14:07:04.999473+08:00","labels":["component:revise","phase:foundational","requirement:FR-004","requirement:FR-005","requirement:FR-022","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-5ao","depends_on_id":"sl-4xh","type":"parent-child","created_at":"2026-02-20T12:34:14.465444+08:00","created_by":"daemon"}]}
{"id":"sl-6pk","title":"Implement --summary flag with compact output and silent auth failure","description":"Add --summary flag that fetches comments and prints a compact listing to stdout, with silent exit on auth failure.","design":"In commands/revise.go RunE: If --summary flag set, early branch: 1) Try auth.GetValidAccessToken(). If error: os.Exit(1) with no output (FR-025 — silent for agent callers). 2) Resolve branch (same as normal flow). 3) Fetch comments via query chain. 4) Format each comment as one line: file_path:line-start_line  'selected_text (truncated to 50 chars)'  (author_name). 5) Print count footer: 'N unresolved comments across M artifacts'. 6) Exit 0. No huh forms, no editor, no agent. Pure stdout output for machine consumption.","acceptance_criteria":"--summary outputs compact listing. Auth failure exits silently (code 1, no stdout). Format is parseable by agents. Count footer accurate.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-20T13:11:00.14815+08:00","updated_at":"2026-02-20T14:11:29.19423+08:00","closed_at":"2026-02-20T14:11:29.19423+08:00","labels":["component:cli","requirement:FR-025","spec:136-revise-comments","story:US9"],"dependencies":[{"issue_id":"sl-6pk","depends_on_id":"sl-7k3","type":"parent-child","created_at":"2026-02-20T13:11:00.149049+08:00","created_by":"daemon"}]}
{"id":"sl-7c7","title":"US8: Automation Mode","description":"Non-interactive --auto flag with fixture file for CI/testing. Prints prompt to stdout for snapshot testing.","acceptance_criteria":"Fixture file parsed. Comments matched by file_path+selected_text. Prompt printed to stdout deterministically. Warnings for unmatched comments. --dry-run writes to file in interactive mode.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-20T13:10:11.056113+08:00","updated_at":"2026-02-20T14:34:35.316821+08:00","closed_at":"2026-02-20T14:34:35.316821+08:00","labels":["phase:us8","spec:136-revise-comments","story:US8"],"dependencies":[{"issue_id":"sl-7c7","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:10:11.056921+08:00","created_by":"daemon"},{"issue_id":"sl-7c7","depends_on_id":"sl-ni8","type":"blocks","created_at":"2026-02-20T13:10:11.220402+08:00","created_by":"daemon"}]}
{"id":"sl-7k3","title":"US9: Summary Flag for Non-Interactive Listing","description":"Compact --summary flag for agent integration. Outputs comment listing to stdout, silent exit on auth failure.","acceptance_criteria":"Compact one-line-per-comment listing to stdout. Silent non-zero exit on auth failure. Usable by /specledger.clarify agent.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-20T13:10:59.864188+08:00","updated_at":"2026-02-20T14:17:46.028081+08:00","closed_at":"2026-02-20T14:17:46.028081+08:00","labels":["phase:us9","spec:136-revise-comments","story:US9"],"dependencies":[{"issue_id":"sl-7k3","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:10:59.86522+08:00","created_by":"daemon"},{"issue_id":"sl-7k3","depends_on_id":"sl-4xh","type":"blocks","created_at":"2026-02-20T13:11:00.030184+08:00","created_by":"daemon"}]}
{"id":"sl-7k3.1","title":"Update clarify prompt to call sl revise --summary","description":"Update .claude/commands/specledger.clarify.md to include a step that calls sl revise --summary to fetch unresolved reviewer comments. This enables the clarify workflow to incorporate reviewer feedback alongside spec ambiguity analysis. User will manually validate if the clarify prompt works as expected after this change.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T13:45:52.17732+08:00","updated_at":"2026-02-20T14:25:04.226276+08:00","closed_at":"2026-02-20T14:25:04.226276+08:00","labels":["component:cli","spec:136-revise-comments","story:US9"],"dependencies":[{"issue_id":"sl-7k3.1","depends_on_id":"sl-7k3","type":"parent-child","created_at":"2026-02-20T13:45:52.177672+08:00","created_by":"daemon"}]}
{"id":"sl-8z4","title":"Implement token estimation and prompt rendering","description":"Render the template with processed comments and estimate token count with warnings.","design":"File: pkg/cli/revise/prompt.go. Functions: RenderPrompt(ctx RevisionContext) (string, error) — renders the embedded template. EstimateTokens(text string) int — returns int(math.Ceil(float64(len(text)) / 3.5)). After rendering: print token count. If \u003c100 tokens: warning 'may lack context'. If \u003e8000 tokens: warning 'may reduce agent effectiveness'. Convert []ProcessedComment to []PromptComment for template context (map fields, set Target from selected_text or line or 'General').","acceptance_criteria":"Prompt renders with all comment details and guidance. Token count within 20% of actual. Warnings shown for short/long prompts.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T12:58:48.055062+08:00","updated_at":"2026-02-20T14:31:46.169482+08:00","closed_at":"2026-02-20T14:31:46.169482+08:00","labels":["component:revise","requirement:FR-012","requirement:FR-015","spec:136-revise-comments","story:US4"],"dependencies":[{"issue_id":"sl-8z4","depends_on_id":"sl-ni8","type":"parent-child","created_at":"2026-02-20T12:58:48.055995+08:00","created_by":"daemon"}]}
{"id":"sl-a7d","title":"US6: Commit, Push, and Comment Resolution","description":"Post-agent lifecycle: file selection for staging, commit/push, and selective comment resolution via API.","acceptance_criteria":"File multi-select for staging. Commit with user message. Push to branch. Resolution multi-select. API calls resolve selected comments. Skip-commit warning. Defer reminder.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-02-20T13:02:06.182803+08:00","updated_at":"2026-02-20T13:02:06.182803+08:00","labels":["phase:us6","spec:136-revise-comments","story:US6"],"dependencies":[{"issue_id":"sl-a7d","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:02:06.183772+08:00","created_by":"daemon"},{"issue_id":"sl-a7d","depends_on_id":"sl-c1h","type":"blocks","created_at":"2026-02-20T13:02:06.348164+08:00","created_by":"daemon"}]}
{"id":"sl-ah5","title":"Implement stash detection and branch checkout with remote support","description":"When user selects a branch different from current, handle dirty state with stash and support remote-only branches.","design":"In commands/revise.go, after branch selection resolves to a different branch: 1) Call deps.GetGitStatus() (go-git worktree.Status()). 2) If dirty: show huh.NewSelect with Stash/Abort/Continue options. 3) If Stash: call deps.StashChanges() (exec: git stash push -m 'sl revise: auto-stash'). Set stashUsed=true flag for session end reminder. 4) If Abort: exit. 5) Check if branch exists locally (go-git refs). If not, check remote (go-git remote.List or refs/remotes/origin/). 6) If remote-only: call deps.CheckoutRemoteTracking(name) (exec: git checkout --track origin/\u003cname\u003e). 7) If local: call deps.CheckoutBranch(name) (go-git worktree.Checkout with Keep:true). 8) At session end: if stashUsed, print 'You have stashed changes. Run git stash pop to restore them.'","acceptance_criteria":"Dirty state detected correctly (go-git). Stash uses exec (go-git gap). Remote branch creates local tracking via exec. Clean checkout uses go-git. Stash pop reminder at end.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-20T13:02:48.090492+08:00","updated_at":"2026-02-20T14:11:29.300612+08:00","closed_at":"2026-02-20T14:11:29.300612+08:00","labels":["component:revise","requirement:FR-003b","requirement:FR-003c","spec:136-revise-comments","story:US7"],"dependencies":[{"issue_id":"sl-ah5","depends_on_id":"sl-yjc","type":"parent-child","created_at":"2026-02-20T13:02:48.091525+08:00","created_by":"daemon"}]}
{"id":"sl-c1h","title":"US5: Launch Coding Agent with Prompt","description":"Launch configured coding agent with finalized prompt. Handle no-agent-configured case. Detect post-agent state.","acceptance_criteria":"Agent launches with prompt as positional arg. TTY preserved. Fallback to write-to-file. Post-agent detects changes vs no-changes on disk.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-20T13:01:01.84997+08:00","updated_at":"2026-02-20T14:34:35.015315+08:00","closed_at":"2026-02-20T14:34:35.015315+08:00","labels":["phase:us5","spec:136-revise-comments","story:US5"],"dependencies":[{"issue_id":"sl-c1h","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:01:01.850795+08:00","created_by":"daemon"},{"issue_id":"sl-c1h","depends_on_id":"sl-ni8","type":"blocks","created_at":"2026-02-20T13:01:02.012412+08:00","created_by":"daemon"}]}
{"id":"sl-ccy","title":"Implement comment display and processing loop","description":"Build the interactive loop that shows each comment and lets the user process, skip, or quit.","design":"In commands/revise.go after artifact selection: Loop through filtered comments. For each: 1) Display formatted comment details using lipgloss styling (file_path, line/start_line if available, selected_text, content, author_name, created_at — FR-010). 2) Show huh.NewSelect with options: Process/Skip/Quit. 3) If Process: show huh.NewText for optional guidance (FR-011), create ProcessedComment{Comment, Guidance, Index}. 4) If Skip: continue to next. 5) If Quit: break loop. 6) After loop: if len(processedComments) == 0, print message and exit. Otherwise proceed to prompt generation.","acceptance_criteria":"Comment details rendered clearly. Process adds to batch with guidance. Skip moves to next. Quit exits loop with processed-so-far. Zero processed = clean exit.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T12:56:49.370244+08:00","updated_at":"2026-02-20T14:28:15.556718+08:00","closed_at":"2026-02-20T14:28:15.556718+08:00","labels":["component:tui","requirement:FR-009","requirement:FR-010","requirement:FR-011","spec:136-revise-comments","story:US3"],"dependencies":[{"issue_id":"sl-ccy","depends_on_id":"sl-t8s","type":"parent-child","created_at":"2026-02-20T12:56:49.371276+08:00","created_by":"daemon"}]}
{"id":"sl-ci7","title":"Implement git helpers in pkg/deps/git.go (go-git + exec hybrid)","description":"Git helper functions for branch detection, stash management, checkout, and commit/push workflows.","design":"File: pkg/deps/git.go (extend existing). Use go-git v5 for most operations, exec fallback for stash and remote tracking checkout.\n\ngo-git based:\n- GetCurrentBranch() — repo.Head().Name().Short()\n- IsFeatureBranch(name) — regex match ^\\d{3}-\n- GetGitStatus() — worktree.Status(), status.IsClean()\n- CheckoutBranch(name) — worktree.Checkout({Branch: ref, Keep: true})\n- FetchRemote() — remote.Fetch()\n- AddFiles(paths) — worktree.Add(path) per file\n- CommitChanges(message) — worktree.Commit(msg, opts)\n- PushToRemote() — repo.Push(opts)\n\nexec-based (go-git gaps):\n- StashChanges() — exec git stash push (go-git issue #606, unimplemented)\n- StashPop() — exec git stash pop\n- CheckoutRemoteTracking(name) — exec git checkout --track origin/name (go-git requires 4-step manual process)\n\nTech debt: consolidate session.GetCurrentBranch/GetProjectID to use this shared module.","acceptance_criteria":"GetCurrentBranch returns correct branch. IsFeatureBranch matches ###-pattern. Stash/checkout/commit operations work in a test git repo.","notes":"go-git stash is unimplemented (issue #606, open since 2022). Remote tracking checkout is 4 manual steps in go-git vs 1-line exec. All other operations work well with go-git. GPG signing gap exists (go-git silently skips if gitconfig has commit.gpgSign=true) — acceptable for this use case.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:34:14.601941+08:00","updated_at":"2026-02-20T14:07:05.101193+08:00","closed_at":"2026-02-20T14:07:05.101193+08:00","labels":["component:revise","phase:foundational","requirement:FR-002","requirement:FR-003b","requirement:FR-003c","requirement:FR-019","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-ci7","depends_on_id":"sl-4xh","type":"parent-child","created_at":"2026-02-20T12:34:14.603136+08:00","created_by":"daemon"}]}
{"id":"sl-cmz","title":"Wire --auto and --dry-run flags into command flow","description":"Integrate automation and dry-run flags into the main revise command flow, branching at the right points.","design":"In commands/revise.go RunE: 1) Parse --auto and --dry-run flags. 2) If --auto: parse fixture, resolve branch from fixture.Branch, fetch comments, match fixture comments, render prompt, print to stdout, exit 0. Skip all huh forms. Warnings to stderr. 3) If --dry-run (interactive): normal flow through processing loop and editor, but after confirm prompt for filename (huh.NewInput), write to file, exit. No agent launch, no resolution. 4) Ensure --auto and interactive flows share the same prompt rendering code (RenderPrompt function).","acceptance_criteria":"--auto prints prompt to stdout, exits 0. --auto with bad fixture shows warnings on stderr. --dry-run prompts for filename, writes prompt, exits. Both skip agent launch and resolution.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-20T13:10:11.4584+08:00","updated_at":"2026-02-20T14:34:35.218168+08:00","closed_at":"2026-02-20T14:34:35.218168+08:00","labels":["component:cli","requirement:FR-023","requirement:FR-024","spec:136-revise-comments","story:US8"],"dependencies":[{"issue_id":"sl-cmz","depends_on_id":"sl-7c7","type":"parent-child","created_at":"2026-02-20T13:10:11.459353+08:00","created_by":"daemon"}]}
{"id":"sl-d8x","title":"Implement fixture file parsing and comment matching","description":"Parse --auto fixture JSON file and match entries against fetched comments by file_path + selected_text.","design":"File: pkg/cli/revise/automation.go. Function: ParseFixture(path string) (*AutoFixture, error) — read JSON file, unmarshal to AutoFixture struct. Function: MatchFixtureComments(fixture *AutoFixture, comments []ReviewComment) ([]ProcessedComment, []string) — match each fixture entry to a fetched comment by file_path + selected_text. Return matched ProcessedComments (with guidance from fixture) and warnings for unmatched entries. Warnings printed to stderr (not stdout, since stdout is the prompt).","acceptance_criteria":"Valid fixture parsed correctly. Comments matched by file_path + selected_text. Unmatched entries produce stderr warnings. Matched comments have guidance from fixture.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-02-20T13:10:11.335285+08:00","updated_at":"2026-02-20T14:34:35.117628+08:00","closed_at":"2026-02-20T14:34:35.117628+08:00","labels":["component:revise","requirement:FR-023","spec:136-revise-comments","story:US8"],"dependencies":[{"issue_id":"sl-d8x","depends_on_id":"sl-7c7","type":"parent-child","created_at":"2026-02-20T13:10:11.336179+08:00","created_by":"daemon"}]}
{"id":"sl-dc1","title":"Implement agent launch and post-agent state detection","description":"Use LaunchWithPrompt to spawn the agent, then detect whether files changed on disk after agent exits.","design":"In commands/revise.go after prompt confirmed: 1) Check if agent configured (launcher.DefaultAgents, or SPECLEDGER_AGENT env var). 2) If no agent: show message with install instructions, prompt for filename to write prompt to (huh.NewInput), write file, exit. 3) If agent available: call launcher.NewAgentLauncher(agent, cwd).LaunchWithPrompt(prompt). 4) After agent exits: call deps.GetGitStatus() (go-git worktree.Status()). 5) If status.IsClean(): skip commit/push, proceed to resolve (US5.4). 6) If dirty: proceed to commit flow (US6).","acceptance_criteria":"Agent spawns with TTY preserved. No-agent fallback writes to file. Post-agent correctly detects clean vs dirty worktree.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T13:01:02.127641+08:00","updated_at":"2026-02-20T14:34:34.909995+08:00","closed_at":"2026-02-20T14:34:34.909995+08:00","labels":["component:cli","requirement:FR-016","spec:136-revise-comments","story:US5"],"dependencies":[{"issue_id":"sl-dc1","depends_on_id":"sl-c1h","type":"parent-child","created_at":"2026-02-20T13:01:02.12847+08:00","created_by":"daemon"}]}
{"id":"sl-gkq","title":"Group comments by artifact and build multi-select options","description":"After fetching comments, group them by file_path and present a huh multi-select with comment counts per artifact.","design":"In commands/revise.go after comments fetched: 1) Build map[string][]ReviewComment keyed by file_path. 2) Create huh.NewMultiSelect options: label = 'spec.md (4 comments)' format, value = file_path. 3) All artifacts pre-selected by default. 4) If all comments resolved (empty after filtering), exit with 'All comments are resolved. Nothing to process.' (FR-008). 5) After user confirms, filter comments to only selected artifacts. Use huh.NewForm with one group containing the MultiSelect.","acceptance_criteria":"Multi-select shows only artifacts with unresolved comments. Counts accurate. User can deselect artifacts. Only selected artifact comments proceed to processing loop.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T12:47:22.721257+08:00","updated_at":"2026-02-20T14:27:02.4339+08:00","closed_at":"2026-02-20T14:27:02.4339+08:00","labels":["component:tui","requirement:FR-006","requirement:FR-007","spec:136-revise-comments","story:US2"],"dependencies":[{"issue_id":"sl-gkq","depends_on_id":"sl-mkh","type":"parent-child","created_at":"2026-02-20T12:47:22.722195+08:00","created_by":"daemon"}]}
{"id":"sl-krp","title":"US1: Branch Selection and Comment Fetching","description":"Core entry point. Determine which branch to work on, fetch artifact comments. This is the MVP — independently testable.","design":"Orchestrate branch detection (go-git GetCurrentBranch, IsFeatureBranch), auth check, PostgREST query chain (project→spec→change→comments), fast exit on no comments. Uses huh Select for branch confirmation/selection.","acceptance_criteria":"sl revise on a feature branch fetches comments. sl revise on main shows branch picker. sl revise \u003cbranch\u003e skips prompt. Auth failure shows clear error. No comments shows clean exit.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-20T12:45:46.019299+08:00","updated_at":"2026-02-20T14:17:45.827295+08:00","closed_at":"2026-02-20T14:17:45.827295+08:00","labels":["phase:us1","spec:136-revise-comments","story:US1"],"dependencies":[{"issue_id":"sl-krp","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:45:46.020111+08:00","created_by":"daemon"},{"issue_id":"sl-krp","depends_on_id":"sl-4xh","type":"blocks","created_at":"2026-02-20T12:47:03.1363+08:00","created_by":"daemon"}]}
{"id":"sl-m98","title":"Create embedded revision prompt template","description":"Create the Go template file for the revision prompt and embed it in the binary.","design":"File: pkg/cli/revise/prompt.tmpl — Go text/template. Use //go:embed prompt.tmpl in prompt.go. Template takes RevisionContext{SpecKey, Comments[]PromptComment}. Render with text/template.New().Parse(). See plan.md section 4 for the full template content. Template instructs the agent to: read target location, generate 2-3 edit suggestions, use AskUserQuestion, apply edits incrementally.","acceptance_criteria":"Template file embedded at compile time. Renders correctly with sample RevisionContext data. Output is valid markdown that Claude Code can process.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T12:58:47.935365+08:00","updated_at":"2026-02-20T14:31:46.068029+08:00","closed_at":"2026-02-20T14:31:46.068029+08:00","labels":["component:revise","requirement:FR-012","spec:136-revise-comments","story:US4"],"dependencies":[{"issue_id":"sl-m98","depends_on_id":"sl-ni8","type":"parent-child","created_at":"2026-02-20T12:58:47.93632+08:00","created_by":"daemon"}]}
{"id":"sl-mkh","title":"US2: Artifact Multi-Select with Comment Counts","description":"Group fetched comments by artifact, show multi-select with counts, filter to selected artifacts.","acceptance_criteria":"Only artifacts with unresolved comments shown. Counts displayed. Selected artifacts filter the comment list for processing.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-20T12:47:22.255466+08:00","updated_at":"2026-02-20T14:27:02.533049+08:00","closed_at":"2026-02-20T14:27:02.533049+08:00","labels":["phase:us2","spec:136-revise-comments","story:US2"],"dependencies":[{"issue_id":"sl-mkh","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:47:22.256441+08:00","created_by":"daemon"},{"issue_id":"sl-mkh","depends_on_id":"sl-krp","type":"blocks","created_at":"2026-02-20T12:47:22.577259+08:00","created_by":"daemon"}]}
{"id":"sl-nd2","title":"Create pkg/cli/revise/ package with types","description":"Create the revise package directory and types.go with all Go struct definitions from data-model.md.","design":"File: pkg/cli/revise/types.go. Structs: ReviewComment (maps to review_comments table), ProcessedComment (in-memory), RevisionContext + PromptComment (template rendering), AutoFixture + FixtureComment (automation). See specledger/136-revise-comments/data-model.md for all field definitions.","acceptance_criteria":"Package compiles. All structs have correct JSON tags matching PostgREST response fields.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:32:45.218838+08:00","updated_at":"2026-02-20T14:00:53.423319+08:00","closed_at":"2026-02-20T14:00:53.423319+08:00","labels":["component:revise","phase:setup","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-nd2","depends_on_id":"sl-ovq","type":"parent-child","created_at":"2026-02-20T12:32:45.219715+08:00","created_by":"daemon"}]}
{"id":"sl-ndj","title":"Polish: Error handling, edge cases, and lightweight tests","description":"Cross-cutting concerns: error handling for all edge cases, lightweight pure-function tests, and tech debt notes.","acceptance_criteria":"All edge cases from spec handled gracefully. Template/token/fixture tests pass. Tech debt documented.","status":"open","priority":3,"issue_type":"feature","created_at":"2026-02-20T13:15:29.227145+08:00","updated_at":"2026-02-20T13:15:29.227145+08:00","labels":["phase:polish","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-ndj","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:15:29.227921+08:00","created_by":"daemon"},{"issue_id":"sl-ndj","depends_on_id":"sl-a7d","type":"blocks","created_at":"2026-02-20T13:15:29.396442+08:00","created_by":"daemon"}]}
{"id":"sl-ni8","title":"US4: Revision Prompt Generation and Editor Launch","description":"Generate combined revision prompt from template, estimate tokens, launch editor for refinement, confirm/re-edit/cancel.","acceptance_criteria":"Template renders with all processed comments. Token estimate shown with warnings. Editor opens with prompt. Modified text displayed after editor closes.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-20T12:58:47.646706+08:00","updated_at":"2026-02-20T14:31:46.363481+08:00","closed_at":"2026-02-20T14:31:46.363481+08:00","labels":["phase:us4","spec:136-revise-comments","story:US4"],"dependencies":[{"issue_id":"sl-ni8","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:58:47.647471+08:00","created_by":"daemon"},{"issue_id":"sl-ni8","depends_on_id":"sl-t8s","type":"blocks","created_at":"2026-02-20T12:58:47.815111+08:00","created_by":"daemon"}]}
{"id":"sl-ovq","title":"Setup: Project initialization","description":"Initialize package structure, add huh dependency, register sl revise command.","design":"Create pkg/cli/revise/ package, add charmbracelet/huh to go.mod, wire VarReviseCmd into cmd/sl/main.go.","acceptance_criteria":"go build succeeds with sl revise --help showing usage.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-02-20T12:03:07.280999+08:00","updated_at":"2026-02-20T14:01:04.279516+08:00","closed_at":"2026-02-20T14:01:04.279516+08:00","labels":["phase:setup","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-ovq","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:03:07.284381+08:00","created_by":"daemon"}]}
{"id":"sl-sa7","title":"Add charmbracelet/huh dependency","description":"Add the huh form library for interactive TUI prompts (multi-select, confirm, text input).","design":"Run: go get github.com/charmbracelet/huh. Verify in go.mod. huh embeds natively in Bubble Tea programs.","acceptance_criteria":"go build succeeds, huh importable in code.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:32:45.097793+08:00","updated_at":"2026-02-20T14:00:53.344576+08:00","closed_at":"2026-02-20T14:00:53.344576+08:00","labels":["component:deps","phase:setup","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-sa7","depends_on_id":"sl-ovq","type":"parent-child","created_at":"2026-02-20T12:32:45.098585+08:00","created_by":"daemon"}]}
{"id":"sl-si4","title":"Implement branch detection and confirmation flow","description":"Detect current branch, determine if it's a feature branch, and confirm with user or show branch picker.","design":"In commands/revise.go RunE: 1) Call auth.GetValidAccessToken() — error on failure (FR-004). 2) If positional arg provided, use it directly. 3) Call deps.GetCurrentBranch() (go-git: repo.Head().Name().Short()). 4) If IsFeatureBranch (regex ^\\d{3}-), show huh.NewConfirm() to confirm. 5) If not feature branch or user wants different, call client.ListSpecsWithComments(projectID) and show huh.NewSelect() with branch names + comment counts.","acceptance_criteria":"On feature branch: prefills and confirms. On main: shows branch list from API. With explicit arg: skips prompt. Not authenticated: shows error with sl auth login guidance.","notes":"US1.5 acceptance scenario (checkout with stash handling when selecting a different branch) requires US7 (sl-yjc / sl-ah5). In MVP (US1 only), skip checkout — user must already be on the target branch. Branch selection still works for determining spec_key, but actual git checkout is deferred to US7.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:47:03.254807+08:00","updated_at":"2026-02-20T14:11:28.966986+08:00","closed_at":"2026-02-20T14:11:28.966986+08:00","labels":["component:cli","requirement:FR-001","requirement:FR-002","requirement:FR-003","requirement:FR-003a","requirement:FR-004","spec:136-revise-comments","story:US1"],"dependencies":[{"issue_id":"sl-si4","depends_on_id":"sl-krp","type":"parent-child","created_at":"2026-02-20T12:47:03.256197+08:00","created_by":"daemon"}]}
{"id":"sl-ssr","title":"Implement file staging multi-select and commit/push flow","description":"Show changed files, let user select which to stage, enter commit message, commit and push.","design":"In commands/revise.go after agent exit (if dirty): 1) Get changed files from deps.GetGitStatus() (go-git worktree.Status()). 2) Show huh.NewMultiSelect with file paths, all pre-selected. 3) Show huh.NewConfirm for commit. If skip: show warning about inconsistencies (FR-019), huh.NewConfirm to proceed or defer. 4) If commit: show huh.NewInput for commit message. 5) Call deps.AddFiles(selectedFiles) (go-git worktree.Add per file), deps.CommitChanges(message) (go-git worktree.Commit), deps.PushToRemote() (go-git repo.Push). 6) Print commit hash and push confirmation.","acceptance_criteria":"File multi-select shows all changed files. User can deselect. Commit with custom message. Push succeeds. Skip-commit warning shown.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-20T13:02:06.465444+08:00","updated_at":"2026-02-20T13:02:06.465444+08:00","labels":["component:cli","requirement:FR-019","spec:136-revise-comments","story:US6"],"dependencies":[{"issue_id":"sl-ssr","depends_on_id":"sl-a7d","type":"parent-child","created_at":"2026-02-20T13:02:06.466342+08:00","created_by":"daemon"}]}
{"id":"sl-t8s","title":"US3: Interactive Comment Processing Loop","description":"Iterate through selected comments one-by-one with process/skip/quit actions and optional guidance input.","acceptance_criteria":"Each comment displays file, line, selected_text, content, author, date. Process queues with guidance. Skip excludes. Quit exits loop, proceeds to prompt with processed comments.","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-02-20T12:56:49.075531+08:00","updated_at":"2026-02-20T14:28:15.652442+08:00","closed_at":"2026-02-20T14:28:15.652442+08:00","labels":["phase:us3","spec:136-revise-comments","story:US3"],"dependencies":[{"issue_id":"sl-t8s","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T12:56:49.077075+08:00","created_by":"daemon"},{"issue_id":"sl-t8s","depends_on_id":"sl-mkh","type":"blocks","created_at":"2026-02-20T12:56:49.246133+08:00","created_by":"daemon"}]}
{"id":"sl-tmq","title":"Extend AgentLauncher with LaunchWithPrompt method","description":"Add a method to pass prompt text as a positional argument to the agent command, preserving TTY interactivity.","design":"File: pkg/cli/launcher/launcher.go. Add method: func (l *AgentLauncher) LaunchWithPrompt(prompt string) error. Implementation: cmd := exec.Command(l.Command, prompt); cmd.Stdin/Stdout/Stderr = os.Stdin/Stdout/Stderr; cmd.Dir = l.Dir; return cmd.Run(). Critical: prompt is positional arg, NOT stdin, to preserve TTY. See plan.md section 5 for the exact code.","acceptance_criteria":"LaunchWithPrompt spawns claude with the prompt argument. TTY is preserved (user can interact with agent). Agent exits cleanly and control returns to caller.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:34:14.717101+08:00","updated_at":"2026-02-20T14:07:05.198496+08:00","closed_at":"2026-02-20T14:07:05.198496+08:00","labels":["component:launcher","phase:foundational","requirement:FR-016","spec:136-revise-comments"],"dependencies":[{"issue_id":"sl-tmq","depends_on_id":"sl-4xh","type":"parent-child","created_at":"2026-02-20T12:34:14.718032+08:00","created_by":"daemon"}]}
{"id":"sl-tv9","title":"Implement editor launch and confirm/re-edit flow","description":"Write rendered prompt to temp file, launch user's editor, read back modified content, present confirm/re-edit/cancel options.","design":"File: pkg/cli/revise/editor.go. Function: EditPrompt(prompt string) (string, error). Implementation: 1) os.CreateTemp('', 'sl-revise-*.md'). 2) Write prompt to temp file. 3) Detect editor: os.Getenv('EDITOR'), os.Getenv('VISUAL'), fallback 'vi'. 4) exec.Command(editor, tmpFile.Name()) with Stdin/Stdout/Stderr = os.Stdin/Stdout/Stderr. 5) cmd.Run(). 6) os.ReadFile(tmpFile.Name()). 7) os.Remove(tmpFile.Name()). 8) Return modified content. In commands/revise.go: after EditPrompt, show huh.NewSelect with Launch/Re-edit/Write-to-file/Cancel. If Re-edit: loop back. If editor not found: fall back to displaying prompt in terminal and prompting for filename.","acceptance_criteria":"Editor opens with prompt content. Modified text returned after save/close. Confirm/re-edit/cancel works. Editor-not-found fallback works.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-02-20T12:58:48.174548+08:00","updated_at":"2026-02-20T14:31:46.267736+08:00","closed_at":"2026-02-20T14:31:46.267736+08:00","labels":["component:revise","requirement:FR-013","requirement:FR-014","spec:136-revise-comments","story:US4"],"dependencies":[{"issue_id":"sl-tv9","depends_on_id":"sl-ni8","type":"parent-child","created_at":"2026-02-20T12:58:48.175545+08:00","created_by":"daemon"}]}
{"id":"sl-vo6","title":"Implement comment fetching via PostgREST query chain","description":"Fetch unresolved artifact comments for the resolved spec key using the 4-step PostgREST query chain.","design":"In commands/revise.go after branch resolved: 1) Parse git remote for repo_owner/repo_name (reuse session.GetProjectID or extract from go-git remote config). 2) client.GetProject(owner, name) → project_id. 3) client.GetSpec(projectID, specKey) → spec_id. 4) client.GetChange(specID) → change_id. 5) client.FetchComments(changeID) → []ReviewComment. 6) If len == 0, print 'No unresolved comments found' and exit 0 (FR-008). All calls use doWithRetry for 401 handling. See contracts/postgrest-api.md for exact endpoints.","acceptance_criteria":"Comments fetched for valid spec key. Fast exit on zero comments. Auth retry works on expired token. Error messages for missing project/spec/change.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-02-20T12:47:03.406309+08:00","updated_at":"2026-02-20T14:11:29.072448+08:00","closed_at":"2026-02-20T14:11:29.072448+08:00","labels":["component:revise","requirement:FR-005","requirement:FR-008","requirement:FR-022","spec:136-revise-comments","story:US1"],"dependencies":[{"issue_id":"sl-vo6","depends_on_id":"sl-krp","type":"parent-child","created_at":"2026-02-20T12:47:03.407668+08:00","created_by":"daemon"}]}
{"id":"sl-x1o","title":"Implement comment resolution multi-select and API calls","description":"Present processed comments for resolution, let user select which to mark resolved, call Supabase API.","design":"In commands/revise.go after commit/push (or skip): 1) Show huh.NewMultiSelect with processed comments (label: truncated file_path + selected_text, value: comment ID). All pre-selected. 2) For each selected: call client.ResolveComment(commentID) — PATCH with {is_resolved: true} via doWithRetry (FR-022). 3) Print resolution count. 4) If user defers entirely: print reminder 'Unresolved comments remain. Re-run sl revise after pushing to resolve them.' (FR-021). 5) Session end: if stash was used earlier, print 'You have stashed changes. Run git stash pop to restore them.'","acceptance_criteria":"Resolution multi-select shows all processed comments. Selected comments resolved via API. Unresolved count shown. Defer reminder printed. Stash pop reminder if applicable.","status":"open","priority":2,"issue_type":"task","created_at":"2026-02-20T13:02:06.580142+08:00","updated_at":"2026-02-20T13:02:06.580142+08:00","labels":["component:revise","requirement:FR-017","requirement:FR-018","requirement:FR-021","requirement:FR-022","spec:136-revise-comments","story:US6"],"dependencies":[{"issue_id":"sl-x1o","depends_on_id":"sl-a7d","type":"parent-child","created_at":"2026-02-20T13:02:06.581361+08:00","created_by":"daemon"}]}
{"id":"sl-yjc","title":"US7: Branch Checkout with Stash Handling","description":"Safe branch switching when user selects a different branch. Detect dirty state, offer stash, handle remote-only branches.","acceptance_criteria":"Dirty state detected. Stash/abort/continue options. Remote branch fetch and local tracking creation. Stash pop reminder at session end.","status":"closed","priority":3,"issue_type":"feature","created_at":"2026-02-20T13:02:47.801676+08:00","updated_at":"2026-02-20T14:17:45.930062+08:00","closed_at":"2026-02-20T14:17:45.930062+08:00","labels":["phase:us7","spec:136-revise-comments","story:US7"],"dependencies":[{"issue_id":"sl-yjc","depends_on_id":"sl-0e7","type":"parent-child","created_at":"2026-02-20T13:02:47.802483+08:00","created_by":"daemon"},{"issue_id":"sl-yjc","depends_on_id":"sl-4xh","type":"blocks","created_at":"2026-02-20T13:02:47.9679+08:00","created_by":"daemon"}]}
